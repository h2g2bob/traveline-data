<!DOCTYPE html>
<html>
<head>
<!--
- factor out hard-coded lat/lng/zoom
- color lines by frequency
- make curvy lines
- hook up some panning / scrolling mechanism
-->
<title>Bus routes</title>
<style type="text/css">
svg {
	background: #003366;
}

svg path {
	fill: white;
	fill-opacity: 0;
	stroke: white;
	stroke-opacity: 1;
	stroke-width: 1px;
}

svg path[frequency=high] {
}
svg path[frequency=medium] {
	opacity: 0.3;
}
svg path[frequency=low] {
	opacity: 0.1;
}

.fullscreen {
	height: 100vh;
	width: 100vw;
	margin: 0;
	padding: 0;
	border: 0;
	overflow: hidden;
}

</style>
<script type="application/javascript">

var tlglobals = {
	zoom: 10000,
	lng: -2.530,
	lat: 51.750
}

function scale(value) {
	/*
	you might think this is possible from transform=scale(1000) and
	stroke-width: 0.001px, but this only makes either invisible or
	thick lines
	*/
	return value * tlglobals.zoom;
}

function descale(value) {
	return value / tlglobals.zoom;
}

function path_description(data, pair) {
	var from_stop = data["stops"][pair["from"]];
	var to_stop = data["stops"][pair["to"]];
	if (from_stop === undefined || to_stop === undefined) {
		return null;
	}
	return "M " + scale(from_stop["lng"]) + " " + scale(from_stop["lat"]) + " L " + scale(to_stop["lng"]) + " " + scale(to_stop["lat"]);
}

function map_paint(data) {
	var svg = document.getElementById("map_paint_area");
	data["pairs"].forEach(function (pair) {
		var path_id = "path_" + pair["from"] + "_" + pair["to"];
		if (document.getElementById(path_id) === null) {
			var path_desc = path_description(data, pair);
			if (path_desc !== null) {
				var path = document.createElementNS("http://www.w3.org/2000/svg", "path");
				path.setAttribute("id", path_id);
				path.setAttribute("d", path_desc);
				path.setAttribute("frequency", frequency_label(pair["frequency"]));
				svg.appendChild(path);
			}
		}
	});
}

function frequency_label(buses_per_hour) {
	if (buses_per_hour >= 4) {
		return "high";
	} else if (buses_per_hour >= 2) {
		return "medium";
	} else {
		return "low";
	}
}

function set_pan_location() {
	var svg = document.getElementById("map_paint_area");
	svg.setAttribute("transform", "translate(" + scale(-tlglobals.lng) + "," + scale(-tlglobals.lat) + ")");
}

function fetch_data_and_repaint() {
	set_pan_location();

	var map_container = document.getElementById("map_paint_container");
	var url = "/json/?lat=" + tlglobals.lat + "&lng=" + tlglobals.lng + "&width=" + descale(map_container.offsetWidth) + "&height=" + descale(map_paint_container.offsetHeight);

	var callback = function () {
		if (xmlhttpreq.readyState == 4) {
			map_paint(JSON.parse(xmlhttpreq.responseText));
		}
	};

	var xmlhttpreq = new XMLHttpRequest();
	xmlhttpreq.addEventListener("load", callback);
	xmlhttpreq.open("GET", url);
	xmlhttpreq.send();
}

function clear_canvas() {
	var svg = document.getElementById("map_paint_area");
	for (var child=svg.firstChild; child !== null; child=svg.firstChild) {
		svg.removeChild(child);
	}
}

window.addEventListener("load", function () {
	fetch_data_and_repaint();
});
window.addEventListener("resize", function () {
	fetch_data_and_repaint();
});
window.addEventListener("keyup", function (event) {
	switch (event.key) {
		case "q":
			tlglobals.zoom *= 1.5;
			clear_canvas(); /* positions of lines on the canvas change when zoom changes */
			fetch_data_and_repaint();
			break;
		case "e":
			tlglobals.zoom /= 1.5;
			clear_canvas(); /* positions of lines on the canvas change when zoom changes */
			fetch_data_and_repaint();
			break;
		case "w":
			tlglobals.lat -= 20/tlglobals.zoom;
			fetch_data_and_repaint();
			break;
		case "s":
			tlglobals.lat += 20/tlglobals.zoom;
			fetch_data_and_repaint();
			break;
		case "a":
			tlglobals.lng -= 20/tlglobals.zoom;
			fetch_data_and_repaint();
			break;
		case "d":
			tlglobals.lng += 20/tlglobals.zoom;
			fetch_data_and_repaint();
			break;
	}
});

</script>
</head>
<body class="fullscreen">
<div id="map_paint_container" class="fullscreen"><svg style="width: 100%; height: 100%" xmlns="http://www.w3.org/2000/svg">
	<g id="map_paint_area">
	</g>
</svg></div>
</body>
