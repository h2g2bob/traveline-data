<!DOCTYPE html>
<html>
<head>
<!--
- factor out hard-coded lat/lng/zoom
- color lines by frequency
- make curvy lines
- hook up some panning / scrolling mechanism
-->
<title>Bus routes</title>
<style type="text/css">
svg {
	background: #003366;
}

svg path {
	fill: white;
	fill-opacity: 0;
	stroke: white;
	stroke-opacity: 1;
	stroke-width: 1px;
}

.fullscreen {
	height: 100vh;
	width: 100vw;
	margin: 0;
	padding: 0;
	border: 0;
	overflow: hidden;
}

</style>
<script type="application/javascript">

function scale(value) {
	/*
	you might think this is possible from transform=scale(1000) and
	stroke-width: 0.001px, but this only makes either invisible or
	thick lines
	*/
	return value * 2000;
}

function descale(value) {
	return value / 2000;
}

function pan_to_location(lng, lat) {
	var svg = document.getElementById("map_paint_area");
	svg.setAttribute("transform", "translate(" + scale(lng) + "," + scale(lat) + ")");
}

function path_description(data, pair) {
	var from_stop = data["stops"][pair["from"]];
	var to_stop = data["stops"][pair["to"]];
	if (from_stop === undefined || to_stop === undefined) {
		return null;
	}
	return "M " + scale(from_stop["lng"]) + " " + scale(from_stop["lat"]) + " L " + scale(to_stop["lng"]) + " " + scale(to_stop["lat"]);
}

function map_paint(data) {
	var svg = document.getElementById("map_paint_area");
	data["pairs"].forEach(function (pair) {
		var path_id = "path_" + pair["from"] + "_" + pair["to"];
		if (document.getElementById(path_id) === null) {
			var path_desc = path_description(data, pair);
			if (path_desc !== null) {
				var path = document.createElementNS("http://www.w3.org/2000/svg", "path");
				path.setAttribute("id", path_id);
				path.setAttribute("d", path_desc);
				svg.appendChild(path);
			}
		}
	});
}

function fetch_data_and_repaint() {
	var map_container = document.getElementById("map_paint_container");
	var lat = 51.750;
	var lng = -2.530;
	var url = "/json/?lat=" + lat + "&lng=" + lng + "&width=" + descale(map_container.offsetWidth) + "&height=" + descale(map_paint_container.offsetHeight);

	var callback = function () {
		if (xmlhttpreq.readyState == 4) {
			pan_to_location(-lng, -lat);
			map_paint(JSON.parse(xmlhttpreq.responseText));
		}
	};

	var xmlhttpreq = new XMLHttpRequest();
	xmlhttpreq.addEventListener("load", callback);
	xmlhttpreq.open("GET", url);
	xmlhttpreq.send();
}


window.addEventListener("load", fetch_data_and_repaint);
window.addEventListener("resize", fetch_data_and_repaint);

</script>
</head>
<body class="fullscreen">
<div id="map_paint_container" class="fullscreen"><svg style="width: 100%; height: 100%" xmlns="http://www.w3.org/2000/svg">
	<g id="map_paint_area">
	</g>
</svg></div>
</body>
